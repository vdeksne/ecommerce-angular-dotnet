<div class="flex mt-32 gap-6">
  <div class="w-3/4">
    <mat-stepper
      (selectionChange)="onStepChange($event)"
      [linear]="true"
      #stepper
      class="bg-white border border-gray-200 shadow-sm"
    >
      <mat-step label="Address" [completed]="completionStatus().address">
        <form [formGroup]="emailForm">
          @if (!isAuthenticated) {
          <div class="mb-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Email</mat-label>
              <input
                matInput
                type="email"
                formControlName="email"
                (input)="onEmailChange()"
                placeholder="your@email.com"
                required
              />
              @if (emailForm.get('email')?.hasError('required') &&
              emailForm.get('email')?.touched) {
              <mat-error>Email is required</mat-error>
              } @if (emailForm.get('email')?.hasError('email') &&
              emailForm.get('email')?.touched) {
              <mat-error>Please enter a valid email</mat-error>
              }
            </mat-form-field>
          </div>
          }
        </form>
        <div id="address-element"></div>
        @if (isAuthenticated) {
        <div class="flex justify-end mt-1">
          <mat-checkbox
            [checked]="saveAddress"
            (change)="onSaveAddressCheckboxChange($event)"
          >
            Save as default address
          </mat-checkbox>
        </div>
        }

        <div class="flex justify-between mt-6">
          <!-- <button class="z-0" routerLink="/shop" mat-stroked-button>Continue shopping</button> -->
          <button
            [disabled]="!completionStatus().address"
            class="z-0"
            matStepperNext
            mat-flat-button
          >
            Next
          </button>
        </div>
      </mat-step>
      <mat-step label="Shipping" [completed]="completionStatus().delivery">
        <app-checkout-delivery
          (deliveryComplete)="handleDeliveryChange($event)"
        ></app-checkout-delivery>
        <div class="flex justify-between mt-6">
          <button matStepperPrevious mat-stroked-button>Back</button>
          <button
            [disabled]="!completionStatus().delivery"
            matStepperNext
            mat-flat-button
          >
            Next
          </button>
        </div>
      </mat-step>
      <mat-step label="Payment" [completed]="completionStatus().card">
        @if (isFreeOrder()) {
        <div
          class="mb-4 p-4 border border-black rounded"
          style="background: white"
        >
          <p
            style="
              font-family: 'Nunito Sans', sans-serif;
              color: black;
              font-weight: 500;
            "
          >
            Save Payment Method for Future Purchases
          </p>
          <p
            style="
              font-family: 'Nunito Sans', sans-serif;
              color: black;
              font-size: 0.875rem;
              margin-top: 0.5rem;
            "
          >
            This order is free. Enter your payment details to save them for
            faster checkout on future purchases.
          </p>
        </div>
        }
        <div id="payment-element"></div>
        <p
          class="text-sm text-gray-600 mt-4"
          style="font-family: 'Nunito Sans', sans-serif; color: #666"
        >
          @if (isLocalhost()) {
          <strong>Note:</strong> Apple Pay is not available on localhost. It
          will appear once deployed to a verified domain. } @else { On desktop:
          Click the Apple Pay button above to see a QR code you can scan with
          your iPhone. }
        </p>
        <div class="flex justify-between mt-6">
          <button matStepperPrevious mat-stroked-button>Back</button>
          <button
            [disabled]="!completionStatus().card"
            matStepperNext
            mat-flat-button
          >
            Next
          </button>
        </div>
      </mat-step>
      <mat-step label="Confirmation">
        @if (isFreeOrder()) {
        <div
          class="mb-4 p-4 border border-black rounded"
          style="background: white"
        >
          <p
            style="
              font-family: 'Nunito Sans', sans-serif;
              color: black;
              font-weight: 500;
            "
          >
            Free Digital Art - No payment required
          </p>
          <p
            style="
              font-family: 'Nunito Sans', sans-serif;
              color: black;
              font-size: 0.875rem;
              margin-top: 0.5rem;
            "
          >
            Complete your order to receive your digital artwork via email.
          </p>
        </div>
        }
        <app-checkout-review
          [confirmationToken]="confirmationToken"
          [shippingAddress]="reviewShippingAddress"
        ></app-checkout-review>
        <div class="flex justify-between mt-6">
          <button matStepperPrevious mat-stroked-button>Back</button>
          <button
            [disabled]="(!isFreeOrder() && !confirmationToken) || loading"
            (click)="confirmPayment(stepper)"
            mat-flat-button
          >
            @if (loading) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            <span
              >@if (isFreeOrder()) { Complete Order } @else { Pay
              {{ cartService.totals()?.total | currency }} }</span
            >
            }
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  </div>
  <div class="w-1/4">
    <app-order-summary></app-order-summary>
  </div>
</div>
